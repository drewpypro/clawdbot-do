# =============================================================================
# Deploy Secrets — Push GitHub Secrets to Docker Swarm
# =============================================================================
# Reads secrets from GitHub's encrypted store, pipes them via SSH directly
# into `docker secret create` on the droplet. Keys never touch disk — they
# go from GitHub's sealed box → SSH pipe → Swarm Raft store (encrypted).
#
# Usage:
#   - Run manually from Actions tab
#   - Set rotate=true to replace existing secrets and force-update services
# =============================================================================

name: Deploy Secrets

on:
  workflow_dispatch:
    inputs:
      rotate:
        description: "Rotate existing secrets (remove + recreate + force-update services)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

env:
  STACK_NAME: clawdbot

jobs:
  deploy-secrets:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Remove existing secrets (rotate only)
        if: inputs.rotate == 'true'
        run: |
          ssh -i ~/.ssh/id_ed25519 clawdbot@${{ secrets.DROPLET_IP }} '
            for secret in anthropic_api_key litellm_master_key \
              discord_bot_token_chat discord_bot_token_security \
              discord_guild_id discord_channel_bots discord_channel_security \
              discord_channel_botfight discord_channel_clawdbot_do; do
              docker secret rm "$secret" 2>/dev/null || true
            done
          '

      - name: Create Docker secrets
        run: |
          SSH_CMD="ssh -i ~/.ssh/id_ed25519 clawdbot@${{ secrets.DROPLET_IP }}"

          create_secret() {
            local name="$1"
            local value="$2"
            echo -n "$value" | $SSH_CMD "docker secret create $name - 2>/dev/null" && \
              echo "  Created: $name" || \
              echo "  Exists:  $name (use rotate=true to replace)"
          }

          echo "Creating Docker Swarm secrets..."
          create_secret "anthropic_api_key"          "${{ secrets.ANTHROPIC_API_KEY }}"
          create_secret "litellm_master_key"         "${{ secrets.LITELLM_MASTER_KEY }}"
          create_secret "discord_bot_token_chat"     "${{ secrets.DISCORD_BOT_TOKEN_CHAT }}"
          create_secret "discord_bot_token_security"  "${{ secrets.DISCORD_BOT_TOKEN_SECURITY }}"
          create_secret "discord_guild_id"           "${{ secrets.DISCORD_GUILD_ID }}"
          create_secret "discord_channel_bots"       "${{ secrets.DISCORD_CHANNEL_BOTS }}"
          create_secret "discord_channel_security"   "${{ secrets.DISCORD_CHANNEL_SECURITY }}"
          create_secret "discord_channel_botfight"   "${{ secrets.DISCORD_CHANNEL_BOTFIGHT }}"
          create_secret "discord_channel_clawdbot_do" "${{ secrets.DISCORD_CHANNEL_CLAWDBOT_DO }}"

      - name: Force-update services (rotate only)
        if: inputs.rotate == 'true'
        run: |
          ssh -i ~/.ssh/id_ed25519 clawdbot@${{ secrets.DROPLET_IP }} '
            for service in $(docker service ls --format "{{.Name}}" | grep "^${{ env.STACK_NAME }}_"); do
              echo "Force-updating: $service"
              docker service update --force "$service"
            done
          '

      - name: Verify secrets
        run: |
          ssh -i ~/.ssh/id_ed25519 clawdbot@${{ secrets.DROPLET_IP }} '
            echo "Docker secrets:"
            docker secret ls
          '

      - name: Cleanup SSH
        if: always()
        run: rm -rf ~/.ssh/id_ed25519
