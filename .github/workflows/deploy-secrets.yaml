###############################################################################
# Deploy Secrets â€” Push secrets from GitHub to Docker Swarm via SSH
# Run after terraform-build creates the droplet, or manually to rotate keys
###############################################################################

name: Deploy Secrets

on:
  workflow_dispatch:
    inputs:
      rotate:
        description: 'Rotate existing secrets (removes and recreates)'
        required: false
        default: 'false'
        type: boolean

jobs:
  deploy-secrets:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Rotate secrets (if requested)
        if: ${{ github.event.inputs.rotate == 'true' }}
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.DROPLET_IP }} '
            for secret in anthropic_api_key litellm_master_key discord_bot_token; do
              docker secret rm $secret 2>/dev/null || true
            done
          '

      - name: Push secrets to Docker Swarm
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.DROPLET_IP }} '
            # Only create if not exists (idempotent)
            echo "${{ secrets.ANTHROPIC_API_KEY }}" | docker secret create anthropic_api_key - 2>/dev/null || echo "anthropic_api_key exists"
            echo "${{ secrets.LITELLM_MASTER_KEY }}" | docker secret create litellm_master_key - 2>/dev/null || echo "litellm_master_key exists"
            echo "${{ secrets.DISCORD_BOT_TOKEN }}" | docker secret create discord_bot_token - 2>/dev/null || echo "discord_bot_token exists"
          '

      - name: Verify secrets
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.DROPLET_IP }} '
            echo "=== Docker Secrets ==="
            docker secret ls
            echo ""
            echo "=== Swarm Status ==="
            docker node ls
          '

      - name: Deploy stack
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.DROPLET_IP }} '
            cd /home/clawdbot/bogoyito-stack
            docker stack deploy -c docker-compose.yml bogoyito
            echo ""
            echo "=== Stack Services ==="
            docker stack services bogoyito
          '

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/id_ed25519
